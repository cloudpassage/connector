sudo: required
language: python
services:
- docker
script:
- export ENVIRONMENT_NAME=CI-CloudPassage-Connector
- export HALO_GROUP_TAG=${ENVIRONMENT_NAME}
- docker run -it --rm -e "AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}" -e "AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}"
  -e "ENVIRONMENT_NAME=${ENVIRONMENT_NAME}" -e "AMI_ID=${AMI_ID}" -e "AWS_SSH_KEY_NAME=${AWS_SSH_KEY_NAME}"
  -e "AWS_REGION=${AWS_REGION}" -e "HALO_GROUP_TAG=${HALO_GROUP_TAG}" -e "HALO_AGENT_KEY=${HALO_AGENT_KEY}"
  -e "SERVER_COUNT=${SERVER_COUNT}" -e "CLI_CMD=${CLI_CMD}" ${IMAGE_NAME} provision
- docker build --build-arg HALO_API_KEY=${HALO_API_KEY} --build-arg HALO_API_SECRET_KEY=${HALO_API_SECRET}
  .
- docker run -it --rm -e "AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}" -e "AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}"
  -e "AWS_REGION=${AWS_REGION}" -e "ENVIRONMENT_NAME=${ENVIRONMENT_NAME}" ${IMAGE_NAME}
  deprovision
after_failure:
- docker run -it --rm -e "AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}" -e "AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}"
  -e "AWS_REGION=${AWS_REGION}" -e "ENVIRONMENT_NAME=${ENVIRONMENT_NAME}" ${IMAGE_NAME}
  deprovision
env:
  global:
  - AMI_ID=ami-28e07e50
  - CLI_CMD=IyEvYmluL3NoCgp5dW0gaW5zdGFsbCBodHRwZAo=
  - IMAGE_NAME=docker.io/halotools/halo-test-environment:v0.1
  - AWS_SSH_KEY_NAME=ci_cloudpassage_halo-test-environment
  - AWS_REGION=us-west-2
  - SERVER_COUNT=5
  - secure: T87wrTMGE7DcYBGgXqbpzJ1/cwJFh5ZDrJjYsZiYr41KO3x+FWIzGzoMqyQNlWryFwNAxHcAFzLmvvYp7RptKZXOiGBnyhMY1MS2lg41FaBD5THcwRdn/tzk884iGrav//+S++lZBmP2Ng+HbtD1+pw5qyy32D5Y3b7PMeVBJSekSkBdEwAwWOroBpvzUu7/mvlvoDtJCYiRVQ8nmHhN+FmS8yMC74dFvPws4kkOWVSrVxxzBfHuLgiv0dYyFWb7GZmhh1E2+a69oGmI4Ux8XWEBvZNQ7POB0gxq607bklBcIxCfz6vWg5K7bxwUly3y26KWLVoWpabdDSZ/wCKEX98olkxbh67LtKkRFVEVJDuANnCDu3lxE3VeIMZ1ugAb2KkJnRcqCMBJxG4l/nLoXIlDTo2nMHPDDgdcdbh2MI6oxmDW2lcvtPuKKGJJulnnI4R/VfFd9wyuNBwsKIBgkNv4jcV47Fa0APg00vLW5ciKSzCtl6q/ZOknAc9f8Xnqtc8PLEYSMzDoe9SxHjtQJDt6vLqS7IIF9+veZ3aPNI4nBSawvD9uNjOfOM+tWiYnMPT7LM3xH6F/HDOxucji7W5t/cDZ4dJuRDZQM2OgSvFqiqjehUehIDCpxKGjrGCgMuTZFmPFf7LwLgdm83yS9T9NAukacxKsHT4fkYs5zqk=
  - secure: JAu83IiFGyf80QYpusv1BhzCw0ylSb6rmaCptyLjm8X2/MoonPtikDlLijd2KDGd+8wAJ5WFtBS9DMeOvJzMNAUna8IjPaqWVHZEcTMsmCZUTcg7ZIfui4dV1DUAN9cOPG+9PVEX5RW8Iz10gXGso22doaYbHX3Ks5A5+JI5FEme/3Pbo7OVfIFYfAOaNSx0JEFR0iNC4Iv9iApV2//ey/4FyH3rkhK8D9y6t2RjARNFYlelRiR6i5D8H5efHIbLlyMKLJjE6hB5ox+CU7KE3yIz2cHPah4ppv7pkFPx1T6MZt5qkQvWzDUYrDEzz6DoGulQ20T37AJE7zAki1bU9+Ifo7iIrxW3XC3ymGhQbNC0B0/4YLBeOIE072oiz8kM8Q2qKCbyIuaIFn4XY2SAlMgoCFOyEyQ/PVn1IvRKlcrYFuYrukf9uX19XqvLbsppNr8qgSxXPPw4wasltZ9B/THS8Em0ZHOJPN4ngVfcKDPzgdRHsriw79OAcdVk9oKgKGMzFGzvS57asZ4EfIKDoNfmd8BrQzXZfhx4a0N4BTmQKimGg0/Q8Mow4vnLpAB7bX1IZDdwzSZM3VZ+tVBHnz6Pz7BMNaAQ8HW3KwZE+XVOR3FwuEbluqAPz3gqMaeCKevqcl2e1Vz9sKOy9OyOP7bC0tRPdfRwBwwPozBiydY=
  - secure: udT8/zvprWj558ayQHlnriPkHY0Whhw5kTdpkNN3MwXYN7inw59+JW+GKePkA1cjZ8oU8nzsr4k6TZNGPtM0HU2003rvwJRiNcRM1g4vGdXS8f2v+MUXHOldgaip2Abr6Y35dKH8xMrKH2d2X3bsC1y49XxZKho2jJ/ycfFESAGFs+6toRlxmKxQpYo8m6LVxz3LhiI5R6BdaV2WaP99qZr339ceCk7rdQoo7rF8e8qDrnL3pkeybY8xrcQQdXcD1qpmSFnymBTeGExYn+SlMSLb6kFVmrcVt+VwMxHzvo9OilMJTuYnGvW7B/XRwF+3c3N4RFsb20Lab5q5ntxhpACLTtZ1oMkqSYYEFZ4WczfrjohEtkAxAO69e2X0OKxPt46o/j8t6gmQQ3jiHmLMjdQX5icgBzTko+ejBk1fWNZ9Xd6BeS9+4U3eZfgJe2JdMshnKNfdBDY2YnrQ11PR9dG/P7/QcUzH5h6oYKwiVxR1C4iCNKaQGyRF30I+x0NeOATd5I4JwjytBi3TQdctxGEnVkh4I+fiAm/4i+XzeSL9dVfhfj4xxK8BhPsMtfC+XYGkz31wcffacjGlJULhKETyelZhYsBumKW1P/cMmddYmeBh6YWX0pjHkHvCMxBkZYH164yOc/GGQvOv35TgBrVA1V4t8NX1BdzlETDA2KI=
  - secure: JHPjSj6fiCl8eBr+/BbOcgc8nSvOpTJVwxUwC6Ji3nYDFiqPN4k59gqJaH7mok1SwEXIcWccoU0PJdmghMAKd8MQ0IQ/MSB/lYj8cYKMHZaTn4NioIObjx8aWQ6Niq6/b5nzxKtPLbX1I/WOLISYDxxLz4C7RSjDx+NCcwlnWbLap7AOgImfTLQrn0+z4MX2l/zD0f/10p5LZ5Jq1Edv01Pwq7PkBbd9HHug5aKeuQ/nPHmSDed6JfIPlzlB0Lph/W/Pf/uNyzQFn32Amp9bkS4KJWYy/M2jkT3Px1YCLJ5m6/yd5zNHijg8vDJUnrCuHTGhgtWRkmvXi0AfUMXFb7kv7xjU3s55/t3cSt+M+MbfWsued6NTnJG+hyLqzvOJNCXZB2oBcOCS3l+b1a86yCJThpXO3MyiDacRFxS7JRcps573cuxJzHsKwrgpZFd4RwBgNuonivEg6j2TC42ZCtz+SN1csslsNBEVpTNwKvAYaP9VzA7qeWhtzuviPCr8FvrZjkZK8pTj92xwEmVQeBsd3TbJ1q38D9TImXHFW2/0KYprxxbkfEQLS5/VCsM0ZlE18GpGLBxuEBVdLc17L4LxbYdSttUzoTEjvzOo4n9ZLJW1bRVKjDb2dWRkkI75/os6XH/rK1QQfQvCc2/WTT4zTfkttw58evcGa1JA5t4=
  - secure: PRtuWoSCcBto1O3C/irv0LxOhA8BKnDeRJBUwArdAIIRO+5L/n7FuQ3zodTMmNMvns32894ND//wf283jaDiuDeGjUAE4vuxnRPTm0iH+iYzMlama7szrrW99qdXRonBN0ubTsRwlDcXTmln3ieQBmHtCuTWHr/B51Cisd2sEib15v7p5XjHJ7iSZANT27c7DYRM1+pV4tv6ggQHlpA6GgLbw6GOp+pm9Yf1vkP3Wt4mpp2E5hVnEQQY0Ju4u3gQXcpkllAXl0c0oBm/Y0Enbff9NHAiQXpl9NSdmDcxxchZPsFsfgzvJDIZI08V1Hkjblsu/uwWDtyfvQ6Z0ouKr87K2k7iSRAUhBnnN8f8pV9kCryVs2b5/kf3JQvhM+odtyxYDVyUZm3dB9EGlXHIInYBuSRbcHJOgOmkPurmVvbDS1yTWH2ugsgdylvNVdWExxnNKquvWOX7/rjnAUXA7djF6qpdidW0x3c4Lw0d3/Tct46Deoqe9Yjltnsq4r58NnTAFc93LSRmm1I4iQbkjAhwc8Ml+czgZWI9yPmPZnFi89ZP2x/c4DGhdvOqBncM/J5kSOC/SGcfE6noATZSKtz1nVuEOlVGX2bRFvXMMnU0th7ZKYysaUMciyhjF7B0ZVInIhaWCPFDCuNlXPf4BCRd5199T/84iy0YaqjAn6k=
